define(["jquery","core/str","theme_receptic/repository","core/paged_content_factory","core/pubsub","core/custom_interaction_events","core/notification","core/templates","core_course/events","block_myoverview/selectors","core/paged_content_events","core/modal_factory","core/modal_events"],function(a,b,c,d,e,f,g,h,i,j,k,l,m){function n(c,d,e,f){var h=[];switch(e){case"makeVisible":h.push({key:"makevisible",component:"theme_receptic"}),h.push({key:"confirmmakevisible",component:"theme_receptic"});break;case"makeInvisible":h.push({key:"makeinvisible",component:"theme_receptic"}),h.push({key:"confirmmakeinvisible",component:"theme_receptic"});break;case"unenrolMe":h.push({key:"unenrolme",component:"theme_receptic"}),h.push({key:"confirmunenrolme",component:"theme_receptic"})}var i;i=l.create({type:l.types.SAVE_CANCEL}),i.then(function(a){a.show()}).fail(g.exception);var j=b.get_strings(h),k=a.when(j,i).then(function(a,b){return b.setTitle(a[0]),b.setBody(a[1]),b.setSaveButtonText(a[0]),b.getRoot().on(m.save,function(){switch(e){case"makeVisible":L(c,d);break;case"makeInvisible":M(c,d);break;case"unenrolMe":O(c,d,f.instanceId),P(c,f.target)}}),b}).fail(g.exception);return k}var o={COURSE_REGION:'[data-region="course-view-content"]',ACTION_HIDE_COURSE:'[data-action="hide-course"]',ACTION_SHOW_COURSE:'[data-action="show-course"]',ACTION_ADD_FAVOURITE:'[data-action="add-favourite"]',ACTION_REMOVE_FAVOURITE:'[data-action="remove-favourite"]',FAVOURITE_ICON:'[data-region="favourite-icon"]',ICON_IS_FAVOURITE:'[data-region="is-favourite"]',ICON_NOT_FAVOURITE:'[data-region="not-favourite"]',PAGED_CONTENT_CONTAINER:'[data-region="page-container"]',ACTION_MAKE_VISIBLE:'[data-action="makevisible-course"]',ACTION_MAKE_INVISIBLE:'[data-action="makeinvisible-course"]',ACTION_UNENROLME:'[data-action="unenrolme"]'},p={COURSES_CARDS:"block_myoverview/view-cards",COURSES_LIST:"block_myoverview/view-list",COURSES_SUMMARY:"block_myoverview/view-summary",NOCOURSES:"core_course/no-courses"},q=[12,24,48],r=[],s=0,t=0,u=0,v=null,w=function(a){var b=a.find(j.courseView.region);return{display:b.attr("data-display"),grouping:b.attr("data-grouping"),sort:b.attr("data-sort"),displaycategories:b.attr("data-displaycategories")}},x={ignoreControlWhileLoading:!0,controlPlacementBottom:!0,persistentLimitKey:"block_myoverview_user_paging_preference"},y=function(a,b){return c.getEnrolledCoursesByTimeline({offset:s,limit:b,classification:a.grouping,sort:a.sort})},z=function(a,b){return a.find(o.FAVOURITE_ICON+'[data-course-id="'+b+'"]')},A=function(a,b){return a.find('[data-region="paged-content-page"][data-page="'+b+'"]')},B=function(a){return a.attr("data-course-id")},C=function(a,b){var c=z(a,b),d=c.find(o.ICON_IS_FAVOURITE);d.addClass("hidden"),d.attr("aria-hidden",!0);var e=c.find(o.ICON_NOT_FAVOURITE);e.removeClass("hidden"),e.attr("aria-hidden",!1)},D=function(a,b){var c=z(a,b),d=c.find(o.ICON_IS_FAVOURITE);d.removeClass("hidden"),d.attr("aria-hidden",!1);var e=c.find(o.ICON_NOT_FAVOURITE);e.addClass("hidden"),e.attr("aria-hidden",!0)},E=function(a,b){return a.find('[data-action="add-favourite"][data-course-id="'+b+'"]')},F=function(a,b){return a.find('[data-action="remove-favourite"][data-course-id="'+b+'"]')},G=function(a,b){var c=F(a,b),d=E(a,b);Q(b,!0).then(function(f){f?(e.publish(i.favourited,b),c.removeClass("hidden"),d.addClass("hidden"),D(a,b)):g.alert("Starring course failed","Could not change favourite state")})["catch"](g.exception)},H=function(a,b){var c=F(a,b),d=E(a,b);Q(b,!1).then(function(f){f?(e.publish(i.unfavorited,b),c.addClass("hidden"),d.removeClass("hidden"),C(a,b)):g.alert("Starring course failed","Could not change favourite state")})["catch"](g.exception)},I=function(a,b){return a.find('[data-action="makevisible-course"][data-course-id="'+b+'"]')},J=function(a,b){return a.find('[data-action="makeinvisible-course"][data-course-id="'+b+'"]')},K=function(a,b){return a.find('[data-region="courses-view"] .coursename[data-course-id="'+b+'"]')},L=function(a,b){var c=I(a,b),d=J(a,b),e=K(a,b);N(b,!0).then(function(a){a?(c.addClass("hidden"),d.removeClass("hidden"),e.removeClass("dimmed")):g.alert("Starring course failed","Could not change favourite state")})["catch"](g.exception)},M=function(a,b){var c=I(a,b),d=J(a,b),e=K(a,b);N(b,!1).then(function(a){a?(c.removeClass("hidden"),d.addClass("hidden"),e.addClass("dimmed")):g.alert("Starring course failed","Could not change favourite state")})["catch"](g.exception)},N=function(a,b){return c.changeCourseVisibility({id:a,visible:b}).then(function(c){return 0==c.warnings.length&&(r.forEach(function(c){c.courses.forEach(function(d,e){d.id==a&&(c.courses[e].visible=b)})}),!0)})["catch"](g.exception)},O=function(a,b,d){return c.unenrolMe({id:b,instanceid:d}).then(function(a){return 0==a.warnings.length})["catch"](g.exception)},P=function(b,c){var e=B(c),f=b.find('[data-region="paging-bar"]'),i=parseInt(f.attr("data-active-page-number")),j=r[i],k=j.courses.reduce(function(a,b){return e!=b.id&&a.push(b),a},[]);if(void 0!=r[i+1]){var l=r[i+1].courses.slice(0,1);r.forEach(function(b,c){if(c>i){var d=[];void 0!=r[c+1]&&(d=r[c+1].courses.slice(0,1)),r[c].courses=a.merge(r[c].courses.slice(1),d)}}),k=a.merge(k,l)}if(t==i+1&&0==r[i+1].courses.length){var m=b.find('[data-region="paged-content-container"]');d.resetLastPageNumber(a(m).attr("id"),i)}r[i].courses=k,s--;var n=A(b,i);R(b,r[i]).then(function(a,b){return h.replaceNodeContents(n,a,b)})["catch"](g.exception),r.forEach(function(a,c){if(c>i){var d=A(b,c);d.remove()}})},Q=function(a,b){return c.setFavouriteCourses({courses:[{id:a,favourite:b}]}).then(function(c){return 0==c.warnings.length&&(r.forEach(function(c){c.courses.forEach(function(d,e){d.id==a&&(c.courses[e].isfavourite=b)})}),!0)})["catch"](g.exception)},R=function(a,b){var c=w(a),d="";if(d="cards"==c.display?p.COURSES_CARDS:"list"==c.display?p.COURSES_LIST:p.COURSES_SUMMARY,"on"!=c.displaycategories&&(b.courses=b.courses.map(function(a){return delete a.coursecategory,a})),b.courses.length)return h.render(d,{courses:b.courses});var e=a.find(j.courseView.region).attr("data-nocoursesimg");return h.render(p.NOCOURSES,{nocoursesimg:e})},S=function(a){this.find(j.courseView.region).attr("data-paging",a)},T=function(a,b){var c=b+k.SET_ITEMS_PER_PAGE_LIMIT;e.subscribe(c,S.bind(a))},U=function(b){v="block_myoverview_"+b.attr("id")+"_"+Math.random();var c=q,e=parseInt(b.find(j.courseView.region).attr("data-paging"),10);e&&(c=q.map(function(a){var b=!1;return a==e&&(b=!0),{value:a,active:b}}));var f=w(b),i=a.extend({},x);i.eventNamespace=v;var k=d.createWithLimit(c,function(c,d){var e=[];return c.forEach(function(c){var h=c.pageNumber,i=c.limit;if(u!=i&&(r=[],s=0,t=0),t==h)return d.allItemsLoaded(t),void e.push(R(b,r[h]));u=i,void 0==r[h+1]&&void 0==r[h]&&(i*=2);var j=y(f,i).then(function(e){var f=e.courses,g=0,i=[];if(void 0!=r[h]){i=r[h].courses;var j=i.length;j<c.limit&&(g=c.limit-j,i=a.merge(r[h].courses,f.slice(0,g)))}else g=c.limit,i=f.slice(0,c.limit);r[h]={courses:i};var k=f.slice(g,f.length);return k.length&&(r[h+1]={courses:k}),r[h].courses.length<c.limit||!k.length?(t=h,d.allItemsLoaded(h)):void 0!=r[h+1]&&r[h+1].courses.length<c.limit&&(t=h+1),s=e.nextoffset,R(b,r[h])})["catch"](g.exception);e.push(j)}),e},i);k.then(function(a,c){return T(b,v),h.replaceNodeContents(b.find(j.courseView.region),a,c)})["catch"](g.exception)},V=function(b){f.define(b,[f.events.activate]),b.on(f.events.activate,o.ACTION_ADD_FAVOURITE,function(c,d){var e=a(c.target).closest(o.ACTION_ADD_FAVOURITE),f=B(e);G(b,f),d.originalEvent.preventDefault()}),b.on(f.events.activate,o.ACTION_REMOVE_FAVOURITE,function(c,d){var e=a(c.target).closest(o.ACTION_REMOVE_FAVOURITE),f=B(e);H(b,f),d.originalEvent.preventDefault()}),b.on(f.events.activate,o.ACTION_MAKE_VISIBLE,function(c,d){var e=a(c.target).closest(o.ACTION_MAKE_VISIBLE),f=B(e);n(b,f,"makeVisible",""),d.originalEvent.preventDefault()}),b.on(f.events.activate,o.ACTION_MAKE_INVISIBLE,function(c,d){var e=a(c.target).closest(o.ACTION_MAKE_INVISIBLE),f=B(e);n(b,f,"makeInvisible",""),d.originalEvent.preventDefault()}),b.on(f.events.activate,o.ACTION_UNENROLME,function(c,d){var e=a(c.target).closest(o.ACTION_UNENROLME),f=B(e),g=a(c.target).attr("data-enrol-id"),h={instanceId:g,target:e};n(b,f,"unenrolMe",h),d.originalEvent.preventDefault()}),b.on(f.events.activate,o.FAVOURITE_ICON,function(a,b){b.originalEvent.preventDefault()}),b.on(f.events.activate,o.ACTION_HIDE_COURSE,function(d,e){var f=a(d.target).closest(o.ACTION_HIDE_COURSE),g=B(f),h={preferences:[{type:"block_myoverview_hidden_course_"+g,value:!0}]};c.updateUserPreferences(h),P(b,f),e.originalEvent.preventDefault()}),b.on(f.events.activate,o.ACTION_SHOW_COURSE,function(d,e){var f=a(d.target).closest(o.ACTION_SHOW_COURSE),g=B(f),h={preferences:[{type:"block_myoverview_hidden_course_"+g,value:null}]};c.updateUserPreferences(h),P(b,f),e.originalEvent.preventDefault()})},W=function(b){b=a(b),r=[],t=0,s=0,U(b),b.attr("data-init")||(V(b),b.attr("data-init",!0))},X=function(a){r.length>0?r.forEach(function(b,c){var d=A(a,c);R(a,b).then(function(a,b){return h.replaceNodeContents(d,a,b)})["catch"](g.exception)}):W(a)};return{init:W,reset:X}});