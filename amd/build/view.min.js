define(["jquery","core/str","theme_receptic/repository","core/paged_content_factory","core/pubsub","core/custom_interaction_events","core/notification","core/templates","core_course/events","theme_receptic/selectors","core/modal_factory","core/modal_events"],function(a,b,c,d,e,f,g,h,i,j,k,l){function m(c,d,e,f){var h=[];switch(e){case"makeVisible":h.push({key:"makevisible",component:"theme_receptic"}),h.push({key:"confirmmakevisible",component:"theme_receptic"});break;case"makeInvisible":h.push({key:"makeinvisible",component:"theme_receptic"}),h.push({key:"confirmmakeinvisible",component:"theme_receptic"});break;case"unenrolMe":h.push({key:"unenrolme",component:"theme_receptic"}),h.push({key:"confirmunenrolme",component:"theme_receptic"})}var i;i=k.create({type:k.types.SAVE_CANCEL}),i.then(function(a){a.show()}).fail(g.exception);var j=b.get_strings(h),m=a.when(j,i).then(function(a,b){return b.setTitle(a[0]),b.setBody(a[1]),b.setSaveButtonText(a[0]),b.getRoot().on(l.save,function(){switch(e){case"makeVisible":J(c,d);break;case"makeInvisible":K(c,d);break;case"unenrolMe":M(c,d,f.instanceId),N(c,f.target)}}),b}).fail(g.exception);return m}var n={COURSE_REGION:'[data-region="course-view-content"]',ACTION_HIDE_COURSE:'[data-action="hide-course"]',ACTION_SHOW_COURSE:'[data-action="show-course"]',ACTION_ADD_FAVOURITE:'[data-action="add-favourite"]',ACTION_REMOVE_FAVOURITE:'[data-action="remove-favourite"]',FAVOURITE_ICON:'[data-region="favourite-icon"]',ICON_IS_FAVOURITE:'[data-region="is-favourite"]',ICON_NOT_FAVOURITE:'[data-region="not-favourite"]',PAGED_CONTENT_CONTAINER:'[data-region="page-container"]',ACTION_MAKE_VISIBLE:'[data-action="makevisible-course"]',ACTION_MAKE_INVISIBLE:'[data-action="makeinvisible-course"]',ACTION_UNENROLME:'[data-action="unenrolme"]'},o={COURSES_CARDS:"block_myoverview/view-cards",COURSES_LIST:"block_myoverview/view-list",COURSES_SUMMARY:"block_myoverview/view-summary",NOCOURSES:"core_course/no-courses"},p=[12,24],q=[],r=0,s=0,t=0,u=function(a){var b=a.find(j.courseView.region);return{display:b.attr("data-display"),grouping:b.attr("data-grouping"),sort:b.attr("data-sort"),displaycategories:b.attr("data-displaycategories")}},v={ignoreControlWhileLoading:!0,controlPlacementBottom:!0},w=function(a,b){return c.getEnrolledCoursesByTimeline({offset:r,limit:b,classification:a.grouping,sort:a.sort})},x=function(a,b){return a.find(n.FAVOURITE_ICON+'[data-course-id="'+b+'"]')},y=function(a,b){return a.find('[data-region="paged-content-page"][data-page="'+b+'"]')},z=function(a){return a.attr("data-course-id")},A=function(a,b){var c=x(a,b),d=c.find(n.ICON_IS_FAVOURITE);d.addClass("hidden"),d.attr("aria-hidden",!0);var e=c.find(n.ICON_NOT_FAVOURITE);e.removeClass("hidden"),e.attr("aria-hidden",!1)},B=function(a,b){var c=x(a,b),d=c.find(n.ICON_IS_FAVOURITE);d.removeClass("hidden"),d.attr("aria-hidden",!1);var e=c.find(n.ICON_NOT_FAVOURITE);e.addClass("hidden"),e.attr("aria-hidden",!0)},C=function(a,b){return a.find('[data-action="add-favourite"][data-course-id="'+b+'"]')},D=function(a,b){return a.find('[data-action="remove-favourite"][data-course-id="'+b+'"]')},E=function(a,b){var c=D(a,b),d=C(a,b);O(b,!0).then(function(f){f?(e.publish(i.favourited,b),c.removeClass("hidden"),d.addClass("hidden"),B(a,b)):g.alert("Starring course failed","Could not change favourite state")})["catch"](g.exception)},F=function(a,b){var c=D(a,b),d=C(a,b);O(b,!1).then(function(f){f?(e.publish(i.unfavorited,b),c.addClass("hidden"),d.removeClass("hidden"),A(a,b)):g.alert("Starring course failed","Could not change favourite state")})["catch"](g.exception)},G=function(a,b){return a.find('[data-action="makevisible-course"][data-course-id="'+b+'"]')},H=function(a,b){return a.find('[data-action="makeinvisible-course"][data-course-id="'+b+'"]')},I=function(a,b){return a.find('[data-region="courses-view"] .coursename[data-course-id="'+b+'"]')},J=function(a,b){var c=G(a,b),d=H(a,b),e=I(a,b);L(b,!0).then(function(a){a?(c.addClass("hidden"),d.removeClass("hidden"),e.removeClass("dimmed")):g.alert("Starring course failed","Could not change favourite state")})["catch"](g.exception)},K=function(a,b){var c=G(a,b),d=H(a,b),e=I(a,b);L(b,!1).then(function(a){a?(c.removeClass("hidden"),d.addClass("hidden"),e.addClass("dimmed")):g.alert("Starring course failed","Could not change favourite state")})["catch"](g.exception)},L=function(a,b){return c.changeCourseVisibility({id:a,visible:b}).then(function(c){return 0==c.warnings.length&&(q.forEach(function(c){c.courses.forEach(function(d,e){d.id==a&&(c.courses[e].visible=b)})}),!0)})["catch"](g.exception)},M=function(a,b,d){return c.unenrolMe({id:b,instanceid:d}).then(function(a){return 0==a.warnings.length})["catch"](g.exception)},N=function(b,c){var e=z(c),f=b.find('[data-region="paging-bar"]'),i=parseInt(f.attr("data-active-page-number")),j=q[i],k=j.courses.reduce(function(a,b){return e!=b.id&&a.push(b),a},[]);if(void 0!=q[i+1]){var l=q[i+1].courses.slice(0,1);q.forEach(function(b,c){if(c>i){var d=[];void 0!=q[c+1]&&(d=q[c+1].courses.slice(0,1)),q[c].courses=a.merge(q[c].courses.slice(1),d)}}),k=a.merge(k,l)}if(s==i+1&&0==q[i+1].courses.length){var m=b.find('[data-region="paged-content-container"]');d.resetLastPageNumber(a(m).attr("id"),i)}q[i].courses=k,r--;var n=y(b,i);P(b,q[i]).then(function(a,b){return h.replaceNodeContents(n,a,b)})["catch"](g.exception),q.forEach(function(a,c){if(c>i){var d=y(b,c);d.remove()}})},O=function(a,b){return c.setFavouriteCourses({courses:[{id:a,favourite:b}]}).then(function(c){return 0==c.warnings.length&&(q.forEach(function(c){c.courses.forEach(function(d,e){d.id==a&&(c.courses[e].isfavourite=b)})}),!0)})["catch"](g.exception)},P=function(a,b){var c=u(a),d="";if(d="cards"==c.display?o.COURSES_CARDS:"list"==c.display?o.COURSES_LIST:o.COURSES_SUMMARY,"on"!=c.displaycategories&&(b.courses=b.courses.map(function(a){return delete a.coursecategory,a})),b.courses.length)return h.render(d,{courses:b.courses});var e=a.find(j.courseView.region).attr("data-nocoursesimg");return h.render(o.NOCOURSES,{nocoursesimg:e})},Q=function(b){var c=u(b),e=d.createWithLimit(p,function(d,e){var f=[];return d.forEach(function(d){var h=d.pageNumber,i=d.limit;if(t!=i&&(q=[],r=0,s=0),s==h)return e.allItemsLoaded(s),void f.push(P(b,q[h]));t=i,void 0==q[h+1]&&void 0==q[h]&&(i*=2);var j=w(c,i).then(function(c){var f=c.courses,g=0,i=[];if(void 0!=q[h]){i=q[h].courses;var j=i.length;j<d.limit&&(g=d.limit-j,i=a.merge(q[h].courses,f.slice(0,g)))}else g=d.limit,i=f.slice(0,d.limit);q[h]={courses:i};var k=f.slice(g,f.length);return k.length&&(q[h+1]={courses:k}),q[h].courses.length<d.limit||!k.length?(s=h,e.allItemsLoaded(h)):void 0!=q[h+1]&&q[h+1].courses.length<d.limit&&(s=h+1),r=c.nextoffset,P(b,q[h])})["catch"](g.exception);f.push(j)}),f},v);e.then(function(a,c){return h.replaceNodeContents(b.find(j.courseView.region),a,c)})["catch"](g.exception)},R=function(b){f.define(b,[f.events.activate]),b.on(f.events.activate,n.ACTION_ADD_FAVOURITE,function(c,d){var e=a(c.target).closest(n.ACTION_ADD_FAVOURITE),f=z(e);E(b,f),d.originalEvent.preventDefault()}),b.on(f.events.activate,n.ACTION_REMOVE_FAVOURITE,function(c,d){var e=a(c.target).closest(n.ACTION_REMOVE_FAVOURITE),f=z(e);F(b,f),d.originalEvent.preventDefault()}),b.on(f.events.activate,n.ACTION_MAKE_VISIBLE,function(c,d){var e=a(c.target).closest(n.ACTION_MAKE_VISIBLE),f=z(e);m(b,f,"makeVisible",""),d.originalEvent.preventDefault()}),b.on(f.events.activate,n.ACTION_MAKE_INVISIBLE,function(c,d){var e=a(c.target).closest(n.ACTION_MAKE_INVISIBLE),f=z(e);m(b,f,"makeInvisible",""),d.originalEvent.preventDefault()}),b.on(f.events.activate,n.ACTION_UNENROLME,function(c,d){var e=a(c.target).closest(n.ACTION_UNENROLME),f=z(e),g=a(c.target).attr("data-enrol-id"),h={instanceId:g,target:e};m(b,f,"unenrolMe",h),d.originalEvent.preventDefault()}),b.on(f.events.activate,n.FAVOURITE_ICON,function(a,b){b.originalEvent.preventDefault()}),b.on(f.events.activate,n.ACTION_HIDE_COURSE,function(d,e){var f=a(d.target).closest(n.ACTION_HIDE_COURSE),g=z(f),h={preferences:[{type:"block_myoverview_hidden_course_"+g,value:!0}]};c.updateUserPreferences(h),N(b,f),e.originalEvent.preventDefault()}),b.on(f.events.activate,n.ACTION_SHOW_COURSE,function(d,e){var f=a(d.target).closest(n.ACTION_SHOW_COURSE),g=z(f),h={preferences:[{type:"block_myoverview_hidden_course_"+g,value:null}]};c.updateUserPreferences(h),N(b,f),e.originalEvent.preventDefault()})},S=function(b){b=a(b),q=[],s=0,r=0,b.attr("data-init")||(R(b),b.attr("data-init",!0)),Q(b)},T=function(a){q.length>0?q.forEach(function(b,c){var d=y(a,c);P(a,b).then(function(a,b){return h.replaceNodeContents(d,a,b)})["catch"](g.exception)}):S(a)};return{init:S,reset:T}});