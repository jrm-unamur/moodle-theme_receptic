define ("theme_receptic/view",["jquery","core/str","theme_receptic/repository","core/paged_content_factory","core/pubsub","core/custom_interaction_events","core/notification","core/templates","core_course/events","block_myoverview/selectors","core/paged_content_events","core/modal_factory","core/modal_events"],function(a,b,c,d,e,f,g,h,i,j,k,l,m){var o={COURSE_REGION:"[data-region=\"course-view-content\"]",ACTION_HIDE_COURSE:"[data-action=\"hide-course\"]",ACTION_SHOW_COURSE:"[data-action=\"show-course\"]",ACTION_ADD_FAVOURITE:"[data-action=\"add-favourite\"]",ACTION_REMOVE_FAVOURITE:"[data-action=\"remove-favourite\"]",FAVOURITE_ICON:"[data-region=\"favourite-icon\"]",ICON_IS_FAVOURITE:"[data-region=\"is-favourite\"]",ICON_NOT_FAVOURITE:"[data-region=\"not-favourite\"]",PAGED_CONTENT_CONTAINER:"[data-region=\"page-container\"]",ACTION_MAKE_VISIBLE:"[data-action=\"makevisible-course\"]",ACTION_MAKE_INVISIBLE:"[data-action=\"makeinvisible-course\"]",ACTION_UNENROLME:"[data-action=\"unenrolme\"]"},p={COURSES_CARDS:"block_myoverview/view-cards",COURSES_LIST:"block_myoverview/view-list",COURSES_SUMMARY:"block_myoverview/view-summary",NOCOURSES:"core_course/no-courses"},q={GROUPING_ALLINCLUDINGHIDDEN:"allincludinghidden",GROUPING_ALL:"all",GROUPING_INPROGRESS:"inprogress",GROUPING_FUTURE:"future",GROUPING_PAST:"past",GROUPING_FAVOURITES:"favourites",GROUPING_HIDDEN:"hidden"},r=[12,24,48,96,0],s=[],t=0,u=0,v=0,w=null;function n(c,d,e,f){var h=[];switch(e){case"makeVisible":h.push({key:"makevisible",component:"theme_receptic"});h.push({key:"confirmmakevisible",component:"theme_receptic"});break;case"makeInvisible":h.push({key:"makeinvisible",component:"theme_receptic"});h.push({key:"confirmmakeinvisible",component:"theme_receptic"});break;case"unenrolMe":h.push({key:"unenrolme",component:"theme_receptic"});h.push({key:"confirmunenrolme",component:"theme_receptic"});break;}var i=l.create({type:l.types.SAVE_CANCEL});i.then(function(a){a.show()}).fail(g.exception);var j=b.get_strings(h),k=a.when(j,i).then(function(a,b){b.setTitle(a[0]);b.setBody(a[1]);b.setSaveButtonText(a[0]);b.getRoot().on(m.save,function(){switch(e){case"makeVisible":O(c,d);break;case"makeInvisible":P(c,d);break;case"unenrolMe":R(c,d,f.instanceId);X(c,f.target);break;}});return b}).fail(g.exception);return k}var x=function(a){var b=a.find(j.courseView.region);return{display:b.attr("data-display"),grouping:b.attr("data-grouping"),sort:b.attr("data-sort"),displaycategories:b.attr("data-displaycategories"),customfieldname:b.attr("data-customfieldname"),customfieldvalue:b.attr("data-customfieldvalue")}},y={ignoreControlWhileLoading:!0,controlPlacementBottom:!0,persistentLimitKey:"block_myoverview_user_paging_preference"},z=function(a,b){return c.getEnrolledCoursesByTimeline({offset:t,limit:b,classification:a.grouping,sort:a.sort,customfieldname:a.customfieldname,customfieldvalue:a.customfieldvalue})},A=function(a,b){return a.find(o.FAVOURITE_ICON+"[data-course-id=\""+b+"\"]")},B=function(a,b){return a.find("[data-region=\"paged-content-page\"][data-page=\""+b+"\"]")},C=function(a){return a.attr("data-course-id")},D=function(a,b){var c=A(a,b),d=c.find(o.ICON_IS_FAVOURITE);d.addClass("hidden");d.attr("aria-hidden",!0);var e=c.find(o.ICON_NOT_FAVOURITE);e.removeClass("hidden");e.attr("aria-hidden",!1)},E=function(a,b){var c=A(a,b),d=c.find(o.ICON_IS_FAVOURITE);d.removeClass("hidden");d.attr("aria-hidden",!1);var e=c.find(o.ICON_NOT_FAVOURITE);e.addClass("hidden");e.attr("aria-hidden",!0)},F=function(a,b){return a.find("[data-action=\"add-favourite\"][data-course-id=\""+b+"\"]")},G=function(a,b){return a.find("[data-action=\"remove-favourite\"][data-course-id=\""+b+"\"]")},H=function(a,b){var c=G(a,b),d=F(a,b);Y(b,!0).then(function(f){if(f){e.publish(i.favourited,b);c.removeClass("hidden");d.addClass("hidden");E(a,b)}else{g.alert("Starring course failed","Could not change favourite state")}}).catch(g.exception)},I=function(a,b){var c=G(a,b),d=F(a,b);Y(b,!1).then(function(f){if(f){e.publish(i.unfavorited,b);c.addClass("hidden");d.removeClass("hidden");D(a,b)}else{g.alert("Starring course failed","Could not change favourite state")}}).catch(g.exception)},J=function(a,b){return a.find("[data-action=\"makevisible-course\"][data-course-id=\""+b+"\"]")},K=function(a,b){return a.find("[data-action=\"makeinvisible-course\"][data-course-id=\""+b+"\"]")},L=function(a,b){return a.find("[data-region=\"courses-view\"] .coursename[data-course-id=\""+b+"\"]")},M=function(a,b){return a.find("[data-region=\"courses-view\"] .course-listitem[data-course-id=\""+b+"\"]")},N=function(a,b){return a.find("[data-region=\"courses-view\"] .hiddenwarning[data-course-id=\""+b+"\"]")},O=function(a,b){var c=J(a,b),d=K(a,b),e=L(a,b),f=N(a,b);Q(b,!0).then(function(a){if(a){c.addClass("hidden");d.removeClass("hidden");e.removeClass("text-muted");f.removeClass("d-flex").addClass("d-none")}else{g.alert("Starring course failed","Could not change favourite state")}}).catch(g.exception)},P=function(a,b){var c=J(a,b),d=K(a,b),e=L(a,b),f=N(a,b);Q(b,!1).then(function(a){if(a){c.removeClass("hidden");d.addClass("hidden");e.addClass("text-muted");f.removeClass("d-none").addClass("d-flex")}else{g.alert("Starring course failed","Could not change favourite state")}}).catch(g.exception)},Q=function(a,b){return c.changeCourseVisibility({id:a,visible:b}).then(function(c){if(0==c.warnings.length){s.forEach(function(c){c.courses.forEach(function(d,e){if(d.id==a){c.courses[e].visible=b}})});return!0}else{return!1}}).catch(g.exception)},R=function(b,d,e){return c.unenrolMe({id:d,instanceid:e}).then(function(c){if(0==c.warnings.length){var e=M(b,d);a(e).remove();return!0}else{return!1}}).catch(g.exception)},S=function(a,b){return a.find("[data-action=\"hide-course\"][data-course-id=\""+b+"\"]")},T=function(a,b){return a.find("[data-action=\"show-course\"][data-course-id=\""+b+"\"]")},U=function(a,b){var c=S(a,b),d=T(a,b),e=x(a);W(b,!0);if(e.grouping!=q.GROUPING_ALLINCLUDINGHIDDEN){X(a,b)}c.addClass("hidden");d.removeClass("hidden")},V=function(a,b){var c=S(a,b),d=T(a,b),e=x(a);W(b,null);if(e.grouping!=q.GROUPING_ALLINCLUDINGHIDDEN){X(a,b)}c.removeClass("hidden");d.addClass("hidden")},W=function(a,b){if(!1===b){b=null}return c.updateUserPreferences({preferences:[{type:"block_myoverview_hidden_course_"+a,value:b}]})},X=function(b,c){var e=b.find("[data-region=\"paging-bar\"]"),f=parseInt(e.attr("data-active-page-number")),i=s[f],j=i.courses.reduce(function(a,b){if(c!=b.id){a.push(b)}return a},[]);if(s[f+1]!=void 0){var k=s[f+1].courses.slice(0,1);s.forEach(function(b,c){if(c>f){var d=[];if(s[c+1]!=void 0){d=s[c+1].courses.slice(0,1)}s[c].courses=a.merge(s[c].courses.slice(1),d)}});j=a.merge(j,k)}if(u==f+1&&0==s[f+1].courses.length){var l=b.find("[data-region=\"paged-content-container\"]");d.resetLastPageNumber(a(l).attr("id"),f)}s[f].courses=j;t--;var m=B(b,f);Z(b,s[f]).then(function(a,b){return h.replaceNodeContents(m,a,b)}).catch(g.exception);s.forEach(function(a,c){if(c>f){var d=B(b,c);d.remove()}})},Y=function(a,b){return c.setFavouriteCourses({courses:[{id:a,favourite:b}]}).then(function(c){if(0==c.warnings.length){s.forEach(function(c){c.courses.forEach(function(d,e){if(d.id==a){c.courses[e].isfavourite=b}})});return!0}else{return!1}}).catch(g.exception)},Z=function(a,b){var c=x(a),d="";if("card"==c.display){d=p.COURSES_CARDS}else if("list"==c.display){d=p.COURSES_LIST}else{d=p.COURSES_SUMMARY}b.courses=b.courses.map(function(a){a.showcoursecategory="on"==c.displaycategories?!0:!1;return a});if(b.courses.length){return h.render(d,{courses:b.courses})}else{var e=a.find(j.courseView.region).attr("data-nocoursesimg");return h.render(p.NOCOURSES,{nocoursesimg:e})}},$=function(a){this.find(j.courseView.region).attr("data-paging",a)},_=function(a,b){var c=b+k.SET_ITEMS_PER_PAGE_LIMIT;e.subscribe(c,$.bind(a))},aa=function(b){w="block_myoverview_"+b.attr("id")+"_"+Math.random();var c=parseInt(b.find(j.courseView.region).attr("data-paging"),10),e=r.map(function(a){var b=!1;if(a==c){b=!0}return{value:a,active:b}}),f=parseInt(b.find(j.courseView.region).attr("data-totalcoursecount"),10);e=e.filter(function(a){return a.value<f||0===a.value});var i=x(b),k=a.extend({},y);k.eventNamespace=w;var l=d.createWithLimit(e,function(c,d){var e=[];c.forEach(function(c){var f=c.pageNumber,h=0<c.limit?c.limit:0;if(v!=h){s=[];t=0;u=0}if(u==f){d.allItemsLoaded(u);e.push(Z(b,s[f]));return}v=h;if(s[f+1]==void 0){if(s[f]==void 0){h*=2}}var j=z(i,h).then(function(e){var g=e.courses,h=0,i=[];if(s[f]!=void 0){i=s[f].courses;var j=i.length;if(j<c.limit){h=c.limit-j;i=a.merge(s[f].courses,g.slice(0,h))}}else{h=c.limit||!1;i=0<c.limit?g.slice(0,c.limit):g}s[f]={courses:i};var k=!1!==h?g.slice(h,g.length):[];if(k.length){s[f+1]={courses:k}}if(s[f].courses.length<c.limit||!k.length){u=f;d.allItemsLoaded(f)}else if(s[f+1]!=void 0&&s[f+1].courses.length<c.limit){u=f+1}t=e.nextoffset;return Z(b,s[f])}).catch(g.exception);e.push(j)});return e},k);l.then(function(a,c){_(b,w);return h.replaceNodeContents(b.find(j.courseView.region),a,c)}).catch(g.exception)},ba=function(b){f.define(b,[f.events.activate]);b.on(f.events.activate,o.ACTION_ADD_FAVOURITE,function(c,d){var e=a(c.target).closest(o.ACTION_ADD_FAVOURITE),f=C(e);H(b,f);d.originalEvent.preventDefault()});b.on(f.events.activate,o.ACTION_REMOVE_FAVOURITE,function(c,d){var e=a(c.target).closest(o.ACTION_REMOVE_FAVOURITE),f=C(e);I(b,f);d.originalEvent.preventDefault()});b.on(f.events.activate,o.ACTION_MAKE_VISIBLE,function(c,d){var e=a(c.target).closest(o.ACTION_MAKE_VISIBLE),f=C(e);n(b,f,"makeVisible","");d.originalEvent.preventDefault()});b.on(f.events.activate,o.ACTION_MAKE_INVISIBLE,function(c,d){var e=a(c.target).closest(o.ACTION_MAKE_INVISIBLE),f=C(e);n(b,f,"makeInvisible","");d.originalEvent.preventDefault()});b.on(f.events.activate,o.ACTION_UNENROLME,function(c,d){var e=a(c.target).closest(o.ACTION_UNENROLME),f=C(e),g=a(c.target).attr("data-enrol-id");n(b,f,"unenrolMe",{instanceId:g,target:e});d.originalEvent.preventDefault()});b.on(f.events.activate,o.FAVOURITE_ICON,function(a,b){b.originalEvent.preventDefault()});b.on(f.events.activate,o.ACTION_HIDE_COURSE,function(c,d){var e=a(c.target).closest(o.ACTION_HIDE_COURSE),f=C(e);U(b,f);d.originalEvent.preventDefault()});b.on(f.events.activate,o.ACTION_SHOW_COURSE,function(c,d){var e=a(c.target).closest(o.ACTION_SHOW_COURSE),f=C(e);V(b,f);d.originalEvent.preventDefault()})},ca=function(b){b=a(b);s=[];u=0;t=0;aa(b);if(!b.attr("data-init")){ba(b);b.attr("data-init",!0)}},da=function(a){if(0<s.length){s.forEach(function(b,c){var d=B(a,c);Z(a,b).then(function(a,b){return h.replaceNodeContents(d,a,b)}).catch(g.exception)})}else{ca(a)}};return{init:ca,reset:da}});
//# sourceMappingURL=view.min.js.map
